"""
RoundTable Validator

Validates content constraints for round_table illustrations.
Auto-generated by Illustration Builder.
"""

import json
import logging
import re
from pathlib import Path
from typing import Dict, Any, Tuple, List

logger = logging.getLogger(__name__)


def strip_html_tags(text: str) -> str:
    """Strip HTML tags from text for accurate character counting"""
    return re.sub(r'<[^>]+>', '', text)


class RoundTableValidator:
    """Validates round_table content against character constraints"""

    def __init__(self):
        self.constraints = self._load_constraints()

    def _load_constraints(self) -> Dict:
        """Load constraints from JSON file"""
        path = Path(__file__).parent.parent / "variant_specs" / "round_table_constraints.json"
        try:
            with open(path) as f:
                return json.load(f)
        except FileNotFoundError:
            logger.warning(f"Constraints file not found: {path}")
            return {}

    def get_constraints_for_variant(self, num_elements: int) -> Dict:
        """Get constraints for a specific variant"""
        key = f"round_table_{num_elements}"
        return self.constraints.get(key, {})

    def validate_content(self, content: Dict, num_elements: int) -> Tuple[bool, List[str]]:
        """
        Validate generated content against constraints.

        Returns:
            Tuple of (is_valid, list_of_violations)
        """
        constraints = self.get_constraints_for_variant(num_elements)
        violations = []

        def check_field(field_name: str, value: str, limits: Dict):
            if not isinstance(value, str):
                return
            # Strip HTML tags (like <strong>) for accurate character counting
            visible_text = strip_html_tags(value) if '<' in value else value
            length = len(visible_text)
            min_len = limits.get("min", 0)
            max_len = limits.get("max", 999)
            if length < min_len or length > max_len:
                violations.append(
                    f"{field_name}: {length} chars (expected {min_len}-{max_len})"
                )

        for element_id, element_constraints in constraints.items():
            if isinstance(element_constraints, dict):
                for field, limits in element_constraints.items():
                    if isinstance(limits, dict) and "min" in limits:
                        field_key = f"{element_id}_{field}" if not field.startswith(element_id) else field
                        if field_key in content:
                            check_field(field_key, content[field_key], limits)

        return len(violations) == 0, violations

    def get_character_counts(self, content: Dict, num_elements: int) -> Dict:
        """Get character counts for all string fields in content (excluding HTML tags)"""
        return {k: len(strip_html_tags(v) if '<' in v else v) for k, v in content.items() if isinstance(v, str)}


# Global validator instance
_validator: RoundTableValidator = None


def get_validator() -> RoundTableValidator:
    """Get or create the global validator instance"""
    global _validator
    if _validator is None:
        _validator = RoundTableValidator()
    return _validator
